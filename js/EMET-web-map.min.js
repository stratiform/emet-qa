/*! EMET-web-map 16-04-2018 */

"use strict";var vers="1.6.0";console.log("EMET Web Map version "+vers);var map,stateControl,linkDict,histLinkDict,lookupDict,featureControl,layers={emet_data:{layer:null,raw:null},emet_connex:{layer:null,raw:null},display:{layer:null}},groups={ACT:"NSW"},account="acem",presetBounds={ACT:L.latLngBounds(L.latLng(-35.1086749645,148.7397766113),L.latLng(-35.9457711607,149.4827270508)),NSW:L.latLngBounds(L.latLng(-27.8585039548,140.5261230469),L.latLng(-37.6490340216,154.1162109375)),VIC:L.latLngBounds(L.latLng(-33.6146192923,140.625),L.latLng(-39.3342974298,150.3369140625)),SA:L.latLngBounds(L.latLng(-25.5424414701,128.5620117188),L.latLng(-38.6511983323,141.50390625)),QLD:L.latLngBounds(L.latLng(-10.1419316861,137.28515625),L.latLng(-29.3821750751,154.9072265625)),TAS:L.latLngBounds(L.latLng(-39.1300602421,143.1958007812),L.latLng(-43.9611906389,149.5458984375)),WA:L.latLngBounds(L.latLng(-12.8546489056,111.4892578125),L.latLng(-36.2088230928,129.0673828125)),NT:L.latLngBounds(L.latLng(-10.1419316861,128.3642578125),L.latLng(-26.3918696718,138.4716796875)),all:L.latLngBounds(L.latLng(-9.7090570686,111.26953125),L.latLng(-43.8662180066,155.2587890625))},colours={hub:{curr:"#A51140"},site:{curr:"#556013"},connex:{curr:"#132030",hist:"#4D83C4"}},toggleObj={emet_hub_or_training_site:"all",emet_connex:!1,historical:null};$("#sidebar-content").css("opacity","0").toggle("slide",{direction:"right"},0,function(){$("#sidebar-content").css("opacity","1")});var slid=!1,searchControl=new L.control.fuseSearch({position:"bottomleft",placeholder:"Search hospitals...",panelTitle:"Search EMET hospitals",maxResultLength:10,threshold:.25,title:"Search"}),hubIcon=L.icon({iconUrl:"img/map_icons/hubIcon-alt.png",iconAnchor:[8.5,9],labelAnchor:null}),siteIcon=L.icon({iconUrl:"img/map_icons/siteIcon-alt.png",iconAnchor:[6.5,6.5],labelAnchor:null}),hubIconHist=L.icon({iconUrl:"img/map_icons/hubIcon-hist-alt.png",iconAnchor:[8.5,9],labelAnchor:null}),siteIconHist=L.icon({iconUrl:"img/map_icons/siteIcon-hist-alt.png",iconAnchor:[6.5,6.5],labelAnchor:null});function _lineStyle(e){var t={weight:1.5,opactiy:.9};return t.color="Y"==e.properties.historical?colours.connex.hist:colours.connex.curr,t}var onEachMarker=function(e,t){return e.properties.state in groups&&(e.properties.state=groups[e.properties.state]),"EMET Training Site"==e.properties.emet_hub_or_training_site?"Y"!==e.properties.historical?L.marker(t,{icon:siteIcon,title:e.properties.hospital_name}).setZIndexOffset(50):L.marker(t,{icon:siteIconHist,title:e.properties.hospital_name}).setZIndexOffset(75):"Y"!==e.properties.historical?L.marker(t,{icon:hubIcon,title:e.properties.hospital_name}).setZIndexOffset(100):L.marker(t,{icon:hubIconHist,title:e.properties.hospital_name}).setZIndexOffset(100)},onEachFeature=function(e,t){t.on({click:triggerClickEvents})},EmetControl=L.Control.extend({cssClasses:["leaflet-bar","emet-control"],htmlString:"",onAdd:function(){var e=L.DomUtil.create("div",this.cssClasses.join(" "));return e.innerHTML=this.htmlString,L.DomEvent.disableClickPropagation(e),e}}),emetGeoJSON=L.GeoJSON.extend({setPointType:function(e){e.feature.pointType="EMET Training Site"==e.feature.properties.emet_hub_or_training_site?"site":"hub",e.feature.layer=e},setMarkerType:function(e){},options:{pointToLayer:onEachMarker,onEachFeature:onEachFeature},onAdd:function(e){for(let t in this._layers)e.addLayer(this._layers[t]),this.setPointType(this._layers[t])}}),_geojsonNameLookup=function(e){var t={};for(let a=0;a<e.features.length;a++){t[e.features[a].properties.acem_id]=e.features[a].properties.hospital_name}return t},createInfoHTML=function(e,t,a,i){var r="Y"==e.historical,n=e.historical_desc,o=e.historical_hub_acem_id,l=e.hospital_name,s=r?"Historical":e.emet_hub_or_training_site,c=e.description,d=(new Date(e.last_date).toLocaleDateString(),!!e.photo1&&e.photo1),u=!!e.photo2&&e.photo2,p=!!d&&d.replace("_thumb",""),_=!!u&&u.replace("_thumb",""),h="";if(h+="<div class='sidebar-title'><h1 id='side-title'>"+l+"</h1></div>",h+="<div class='sidebar-top'><img src='img/state_icons/"+a+"-"+t.toUpperCase()+"-ICON.png' alt='"+a+" "+t+" ' /><div><span>"+s+"</span></div></div>",h+="<p class='desc'>"+c+"</p>",null!=n&&(h+="<p class='desc'>"+n+"</p>"),h+="<div class='hosp-list'>","site"!=t||r)if("site"==t&&r)h+="<h2>"+i.site.historical+"</h2>",h+="<ul><li>"+e.linked_emet_hub+"</li></ul>",e.secondary_linked_hub&&(h+="<ul><li>"+e.secondary_linked_hub+"</li></ul>");else if("hub"!=t||r){if("hub"==t&&r){h+="<h2>"+i.hub.historical+"</h2>",h+="<ul>";for(let t=0;t<linkDict[e.acem_id].length;t++)h+="<li>"+linkDict[e.acem_id][t]+"</li>";h+="</ul>"}}else{h+="<h2>"+i.hub.heading+"</h2>",h+="<ul>";for(let t=0;t<linkDict[e.acem_id].length;t++)h+="<li>"+linkDict[e.acem_id][t]+"</li>";if(h+="</ul>",histLinkDict[e.acem_id]){h+="<h2>"+i.hub.historical+"</h2>",h+="<ul>";for(let t=0;t<histLinkDict[e.acem_id].length;t++)h+="<li>"+histLinkDict[e.acem_id][t]+"</li>";h+="</ul>"}}else h+="<h2>"+i.site.heading+"</h2>",h+="<ul><li>"+e.linked_emet_hub+"</li></ul>",e.secondary_linked_hub&&(h+="<ul><li>"+e.secondary_linked_hub+"</li></ul>"),o&&(h+="<h2>"+i.site.historical+"</h2>",h+="<ul><li>"+lookupDict[o]+"</li></ul>");return h+="</div>",e.photo1&&(h+=e.photo2?"<div id='view-images'><img dest='"+p+"' src='"+d+"' /><img dest='"+_+"' src='"+u+"' /></div>":"<div id='view-images'><img dest='"+p+"' src='"+d+"' /></div>"),e.email?(e.url?h+="<p class='foot'>"+i.contact+"<br> <a href='"+e.url+"'>"+e.url+"</a><br>":h+="<p class='foot'>"+i.contact+"<br>",h+="<a href='mailto:"+e.email+"'>"+e.email+"</a></p>"):h+="<p class='foot'>"+i.contact+" <br> <a href='mailto:EMET@acem.org.au'>EMET@acem.org.au</a></p>",h+=""},createLinkDict=function(e){var t={};for(let a in e.features){let i=e.features[a].properties,r=i.emet_hub_or_training_site,n=i.linked_emet_hub_acem_id,o=i.secondary_hub_acem_id,l=i.hospital_name,s=i.acem_id;"EMET Training Site"==r?(n in t?t[n].push(l):t[n]=[l],o in t?t[o].push(l):t[o]=[l]):t[s]||(t[s]=[])}return t},createHistLinkDict=function(e){var t={};for(let a in e.features){let i=e.features[a].properties,r=i.emet_hub_or_training_site,n=i.historical_hub_acem_id,o=i.hospital_name,l=i.acem_id;null!==n&&("EMET Training Site"==r?n in t?t[n].push(o):t[n]=[o]:t[l]||(t[l]=[]))}return t},updateInfoWindow=function(e,t){var a=e.target.feature.properties,i="EMET Training Site"==e.target.feature.properties.emet_hub_or_training_site?"site":"hub",r=a.state,n=$(window).height()-$("#legend").height();$("#"+t).removeClass().addClass(i).html(createInfoHTML(a,i,r,sidebarText)).css("height",n);$("#view-images").viewer({toolbar:!1,movable:!1,zoomable:!1,rotatable:!1,scalable:!1,title:!1,url:"dest"})},_resizeSidebar=function(){var e=$(window).height()-$("#legend").height();$("#sidebar-content").css("height",e)},_featureInDisplay=function(e){var t=!1;return layers.display.eachLayer(function(a){a.feature.properties.acem_id==e&&(t=!0)}),t},triggerClickEvents=function(e){(jQuery.isEmptyObject(linkDict)||jQuery.isEmptyObject(histLinkDict)||jQuery.isEmptyObject(lookupDict))&&(linkDict=createLinkDict(layers.emet_data.raw),histLinkDict=createHistLinkDict(layers.emet_data.raw),lookupDict=_geojsonNameLookup(layers.emet_data.raw)),updateInfoWindow(e,"sidebar-content"),map.closePopup(),layers.emet_data.layer.unbindLabel();var t="EMET Hub"==e.target.feature.properties.emet_hub_or_training_site?"hub":"site",a=!1;if(layers.display.getLayers().length>0&&_featureInDisplay(e.target.feature.properties.acem_id)&&(a=$.extend({},e.target.feature)),_resetLayers(!1),!toggleObj.emet_connex&&"all"==toggleObj.emet_hub_or_training_site)for(let a in layers.emet_connex.raw.features){let i=layers.emet_connex.raw.features[a],r=i.properties.acem_id,n=e.target.feature.properties.acem_id,o=t,l=i.properties.linked_emet_hub_acem_id,s=i.properties.secondary_hub_acem_id,c=i.properties.hub_id;if("site"==o){if(r==n||l==n||s==n){let e={type:"FeatureCollection",features:[i]};layers.emet_connex.layer.addData(e)}}else if((l==n||s==n)&&n==c){let e={type:"FeatureCollection",features:[i]};layers.emet_connex.layer.addData(e)}}for(let t in layers.emet_data.raw.features)if("all"==toggleObj.emet_hub_or_training_site){let i=layers.emet_data.raw.features[t];if($.inArray(i.properties.hospital_name,linkDict[e.target.feature.properties.acem_id])>-1||$.inArray(i.properties.hospital_name,histLinkDict[e.target.feature.properties.acem_id])>-1){let e={type:"FeatureCollection",features:a?[i,a]:[i]};layers.display.addData(e)}else if(e.target.feature.properties.linked_emet_hub_acem_id==i.properties.acem_id||e.target.feature.properties.secondary_hub_acem_id==i.properties.acem_id||e.target.feature.properties.historical_hub_acem_id==i.properties.acem_id){let e={type:"FeatureCollection",features:a?[i,a]:[i]};layers.display.addData(e)}}layers.display.eachLayer(function(e){e.bindLabel(e.feature.properties.hospital_name.replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel();let t="EMET Hub"==e.feature.properties.emet_hub_or_training_site?"hub":"site";"site"==t&&$(e.label._container).addClass("site-label"),"hub"==t&&$(e.label._container).addClass("hub-label")}),slid||($("#sidebar-content").toggle("slide",{direction:"right"}).css("opacity","1"),slid=!0),e.target.bindLabel(e.target.feature.properties.hospital_name.replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel(),"site"==t?$(e.target.label._container).addClass("site-label"):"hub"==t&&$(e.target.label._container).addClass("hub-label")},filterFeatures=function(e,t,a,i,r,n,o,l,s,c){var d;d="id"==e?"#":"class"==e?".":null===e?"":"#",c?$(d+t).change(function(){filterExec($(this).prop(r),a,i,r,n,o,l,s,c)}):$(d+t).click(function(){filterExec($(this).prop(r),a,i,r,n,o,l,s,c)})},filterExec=function(e,t,a,i,r,n,o,l,s){l&&("all"!=e||toggleObj[a]?"none"==e&&($(this).prop(i,"all"),toggleObj[a]=!1):($(this).prop(i,"none"),toggleObj[a]=!0)),("connex"!=e&&"emet_hub_or_training_site"==t||"historical"===t)&&(toggleObj.emet_connex=!1),"historical"===t&&($(".legend-historical").css("display","table-row"),_resizeSidebar()),"historical"!==t&&($(".legend-historical").css("display","none"),_resizeSidebar()),"connex"!=e||toggleObj.emet_connex||(layers.emet_connex.layer.setStyle(function(e){return toggleObj.state&&toggleObj.state!=e.properties.state?{opacity:0}:{opacity:1}}),e="all",toggleObj.emet_connex=!0),"emet_hub_or_training_site"==t&&"connex"!=e&&(toggleObj[t]=e),"historical"==t?(toggleObj[t]="Y",toggleObj.emet_hub_or_training_site="all"):"state"!=t&&(toggleObj.historical=null),"state"==t&&(slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),"all"!=e?toggleObj[t]=e:delete toggleObj[t]),console.log("filterProp: ",t,"toggleObj: ",toggleObj),_filterData(!0,!0),n&&_reindexFeatures(layers.emet_data.filtering,["hospital_name","suburb","state"]),_resetLayers(),o&&map.fitBounds(presetBounds[e])};function _resetLayers(e){e=void 0===e||e,console.log("Resetting layers"),e?(layers.emet_data.layer.clearLayers(),layers.emet_connex.layer.clearLayers(),layers.display.clearLayers(),layers.emet_data.filtering?layers.emet_data.layer.addData(layers.emet_data.filtering):layers.emet_data.layer.addData(layers.emet_data.raw),layers.emet_connex.filtering?layers.emet_connex.layer.addData(layers.emet_connex.filtering):layers.emet_connex.layer.addData(layers.emet_connex.raw)):(layers.emet_connex.layer.clearLayers(),layers.display.clearLayers(),layers.emet_connex.filtering?layers.emet_connex.layer.addData(layers.emet_connex.filtering):layers.emet_connex.layer.addData(layers.emet_connex.raw))}function _reindexFeatures(e,t){searchControl.indexFeatures(e,t)}function _featFilter(e,t){var a=[];for(let t in toggleObj){let i=toggleObj[t];"emet_connex"==t&&"points"==this||("emet_hub_or_training_site"==t&&"connex"==this||("emet_hub_or_training_site"==t&&"all"==i?a.push(!0):"emet_connex"==t&&i?a.push(!0):"emet_hub_or_training_site"==t&&"all"==i?a.push(!0):"historical"==t&&"Y"==i?a.push(!0):i==e.properties[t]?a.push(!0):a.push(!1)))}return a=!(a.indexOf(!1)>-1)}function _filterData(e,t){e&&(layers.emet_data.filtering={},layers.emet_data.filtering={type:"FeatureCollection",features:layers.emet_data.raw.features.filter(_featFilter,"points")},console.log("point feats: ",layers.emet_data.filtering.features.length+" of "+layers.emet_data.raw.features.length)),t&&(layers.emet_connex.filtering={},layers.emet_connex.filtering={type:"FeatureCollection",features:layers.emet_connex.raw.features.filter(_featFilter,"connex")},console.log("connex feats: ",layers.emet_connex.filtering.features.length+" of "+layers.emet_connex.raw.features.length))}var getCartoJSON=function(e,t,a,i){i=i||"SELECT * FROM "+t,t="emet_data_dev"===t?"emet_data":t,$.getJSON("https://"+e+".carto.com/api/v2/sql/?q="+i+"&format=geojson",function(e){if(e.features[0].geometry&&"Point"==e.features[0].geometry.type)layers[t].raw=e,_filterData(!0,!1),layers[t].layer=new emetGeoJSON(layers.emet_data.filtering),searchControl.indexFeatures(e,["hospital_name","suburb","state"]),layers[t].layer.addTo(a);else if(e.features[0].geometry&&"LineString"==e.features[0].geometry.type){let i=JSON.stringify((new Date).getFullYear()).substring(2);layers[t].raw=e,layers[t].layer=new emetGeoJSON({type:"FeatureCollection",features:[]},{style:_lineStyle,attribution:"Â© 2017-"+i+" <a href='https://www.acem.org.au/' target='blank'>ACEM</a>"}).addTo(a)}}).done(function(){layers.emet_data.layer&&layers.emet_connex.layer&&(console.log("...Data received"),a.spin(!1),_filterData(!0,!0))})},createMap=function(){var e=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png",{attribution:"&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"});(map=new L.Map("map",{layers:[e],zoomControl:!1}).on("click",function(){slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),_resetLayers()})).spin(!0),map.fitBounds(presetBounds.all),searchControl.options.mapObj=map,searchControl.addTo(map),L.control.zoom({position:"bottomleft"}).addTo(map);var t="";t+="<h3>Layers</h3>",t+="<input type='radio' name='point-filter' value='EMET Hub' class='hubs'> EMET Hubs<br>",t+="<input type='radio' name='point-filter' value='all' checked class='hubs'> EMET Hubs and Training Sites<br>",t+="<input type='radio' name='point-filter' value='connex' class='hubs'> EMET Hubs and Training Sites with connections<br>",t+="<input type='radio' name='point-filter' value='Y' class='historical'> EMET historical and current sites<br>",(featureControl=new EmetControl({position:"topleft"})).htmlString=t,featureControl.addTo(map),featureControl.getContainer().className+=" feature-control",filterFeatures(null,"input[type='radio'][name='point-filter'].hubs","emet_hub_or_training_site","emet_data","value",!0,!0,!1,!1,!0),filterFeatures(null,"input[type='radio'][name='point-filter'].historical","historical","emet_data","value",!0,!0,!1,!1,!0),stateControl=new EmetControl({position:"topleft"});var a="";a+="<a href='#' id='all' class='dropdown-selection'>Show all states</a>",a+="<a href='#' id='NSW' class='dropdown-selection'>NSW & ACT</a>",a+="<a href='#' id='NT' class='dropdown-selection'>NT</a>",a+="<a href='#' id='QLD' class='dropdown-selection'>QLD</a>",a+="<a href='#' id='SA' class='dropdown-selection'>SA</a>",a+="<a href='#' id='TAS' class='dropdown-selection'>TAS</a>",a+="<a href='#' id='VIC' class='dropdown-selection'>VIC</a>",a="<div class='dropdown'>"+(a="<button class='dropbtn'>Filter by state        &#x25BC;</button>"+(a="<div class='dropdown-content'>"+(a+="<a href='#' id='WA' class='dropdown-selection'>WA</a>")+"</div>"))+"</div>",stateControl.htmlString=a,stateControl.addTo(map),stateControl.getContainer().className+=" state-control",filterFeatures("class","dropdown-selection","state","emet_data","id",!0,!0,!0,!1,!1);var i=new EmetControl({position:"topleft"});i.htmlString='<input id="labelToggle" type="checkbox" checked class="on">Labels</input>',i.addTo(map),i.getContainer().className+=" label-control",$("#labelToggle").change(function(){if($(this).hasClass("on")){$(this).toggleClass("on");var e=$('<style class="hack-style">.leaflet-label { display: none; }</style>');$("html > head").append(e)}else $(this).toggleClass("on"),$(".hack-style").remove()}),$(".dropdown").click(function(){"none"==$(".dropdown-content").css("display")?$(".dropdown-content").show():$(".dropdown-content").hide()}),$(".dropdown-selection").click(function(){$(".dropbtn").html("Showing: "+$(this).prop("id"))}),console.log("Getting data...");getCartoJSON(account,"emet_data_dev",map),getCartoJSON(account,"emet_connex",map,"SELECT ed.acem_id as acem_id, case when (ed.historical_hub_acem_id is not null AND ed.historical_hub_acem_id = ec.acem_id) then ed.historical_hub_acem_id else ed.linked_emet_hub_acem_id end as linked_emet_hub_acem_id, ed.secondary_hub_acem_id as secondary_hub_acem_id, ST_GeomFromGeoJSON(CONCAT('{\"type\":\"LineString\",\"coordinates\":[[',ed.longitude, ', ', ed.latitude,'],[',ec.longitude, ', ', ec.latitude,']] }')) as the_geom, ec.acem_id as hub_id, ed.state as state, case when (ed.historical = 'Y') then 'Y' when (ec.historical = 'Y') then 'Y' when (ed.historical_hub_acem_id is not null AND ed.historical_hub_acem_id = ec.acem_id) then 'Y' else NULL end as historical FROM emet_data_dev ed JOIN emet_data_dev ec ON ed.linked_emet_hub_acem_id = ec.acem_id OR ed.secondary_hub_acem_id = ec.acem_id OR ed.historical_hub_acem_id = ec.acem_id");layers.display=new emetGeoJSON({type:"FeatureCollection",features:[]}).addTo(map)};window.onload=createMap;var sidebarText={contact:"For more information on this EMET program, contact:",site:{heading:"Serviced by:",historical:"Formerly serviced by:"},hub:{heading:"Servicing hospitals:",historical:"Formerly servicing hospitals:"}};